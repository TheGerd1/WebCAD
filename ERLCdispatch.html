<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ER:LC CAD/MDT System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #1a1a1a;
            --secondary-bg: #2d2d2d;
            --accent-bg: #3a3a3a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --border-color: #444444;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --police-color: #0066cc;
            --fire-color: #cc3300;
            --ems-color: #009933;
            --rcms-color: #8a2be2;
            --rcpd-color: #0066cc;
            --lcso-color: #4169e1;
            --lst-color: #1e90ff;
            --rcfd-color: #cc3300;
            --metro-color: #ff8c00;
            --swat-color: #000000;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: var(--secondary-bg);
            border-bottom: 2px solid var(--border-color);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo i {
            font-size: 2rem;
            color: var(--info-color);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .clock {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--info-color);
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1rem;
            padding: 1rem;
            max-width: 1600px;
            margin: 0 auto;
            min-height: calc(100vh - 120px);
        }

        .left-panel {
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 1rem;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Action Bar */
        .action-bar {
            background: var(--secondary-bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn-primary {
            background: var(--info-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-police {
            background: var(--police-color);
            color: white;
        }

        .btn-fire {
            background: var(--fire-color);
            color: white;
        }

        .btn-ems {
            background: var(--ems-color);
            color: white;
        }

        /* Button Group and Submenu */
        .btn-group {
            position: relative;
            display: inline-block;
        }

        .btn-submenu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            min-width: 150px;
            display: none;
            z-index: 1000;
            margin-top: 2px;
        }

        .btn-submenu.active {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        .btn-submenu-item {
            padding: 0.7rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            transition: background 0.2s;
            color: var(--text-primary);
        }

        .btn-submenu-item:hover {
            background: var(--accent-bg);
        }

        /* Data Tables */
        .data-section {
            background: var(--secondary-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .section-header {
            background: var(--accent-bg);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            background: var(--secondary-bg);
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--accent-bg);
            color: var(--text-primary);
            padding: 0.8rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 0.8rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .data-table tr:hover {
            background: var(--accent-bg);
        }

        .data-table tr.selected {
            background: rgba(33, 150, 243, 0.2);
            border-left: 3px solid var(--info-color);
        }

        /* Status Badges */
        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .status-available {
            background: var(--success-color);
            color: white;
        }

        .status-busy {
            background: var(--danger-color);
            color: white;
        }

        .status-enroute {
            background: var(--warning-color);
            color: white;
        }

        .status-onscene {
            background: var(--info-color);
            color: white;
        }

        .status-offline {
            background: var(--text-muted);
            color: white;
        }

        /* Priority Badges */
        .priority-high {
            background: var(--danger-color);
            color: white;
        }

        .priority-medium {
            background: var(--warning-color);
            color: white;
        }

        .priority-low {
            background: var(--success-color);
            color: white;
        }

        .priority-routine {
            background: var(--text-muted);
            color: white;
        }

        /* Department Colors */
        .dept-police {
            color: var(--police-color);
            font-weight: 600;
        }

        .dept-fire {
            color: var(--fire-color);
            font-weight: 600;
        }

        .dept-ems {
            color: var(--ems-color);
            font-weight: 600;
        }

        .dept-rcms {
            color: var(--rcms-color);
            font-weight: 600;
        }

        .dept-rcpd {
            color: var(--rcpd-color);
            font-weight: 600;
        }

        .dept-lcso {
            color: var(--lcso-color);
            font-weight: 600;
        }

        .dept-lst {
            color: var(--lst-color);
            font-weight: 600;
        }

        .dept-rcfd {
            color: var(--rcfd-color);
            font-weight: 600;
        }

        .dept-metro {
            color: var(--metro-color);
            font-weight: 600;
        }

        .dept-swat {
            color: var(--swat-color);
            font-weight: 600;
            background: white;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 0.3rem;
        }

        .quick-btn {
            padding: 0.3rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            background: var(--accent-bg);
            color: var(--text-primary);
            transition: background 0.2s;
        }

        .quick-btn:hover {
            background: var(--border-color);
        }

        /* Right Panel Components */
        .active-calls {
            flex: 1;
        }

        .dispatch-log {
            height: 300px;
        }

        .log-container {
            height: 250px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--primary-bg);
            border-radius: 4px;
            margin-top: 1rem;
        }

        .log-entry {
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background: var(--secondary-bg);
            border-radius: 4px;
            border-left: 3px solid var(--info-color);
            font-size: 0.85rem;
        }

        .log-time {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-bottom: 0.2rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
        }

        .modal-content {
            background: var(--secondary-bg);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--accent-bg);
            color: var(--text-primary);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--accent-bg);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--info-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        .form-select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--accent-bg);
            color: var(--text-primary);
            cursor: pointer;
        }

        .form-textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--accent-bg);
            color: var(--text-primary);
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
            }

            .right-panel {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .header-stats {
                gap: 1rem;
            }

            .action-buttons {
                justify-content: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 0;
            z-index: 3000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            min-width: 180px;
            display: none;
        }

        .context-menu-item {
            padding: 0.7rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            transition: background 0.2s;
            position: relative;
        }

        .context-menu-item:hover {
            background: var(--accent-bg);
        }

        .context-menu-item.danger:hover {
            background: var(--danger-color);
        }

        .context-menu-item.has-submenu::after {
            content: '▶';
            margin-left: auto;
            font-size: 0.7rem;
        }

        .submenu {
            position: absolute;
            left: 100%;
            top: 0;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            min-width: 150px;
            display: none;
            z-index: 3001;
        }

        .context-menu-item:hover .submenu {
            display: block;
        }

        .submenu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .submenu-item:hover {
            background: var(--accent-bg);
        }

        /* Pit Timer Styles */
        .pit-timer {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: var(--secondary-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            min-width: 280px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            z-index: 4000;
            display: none;
        }

        .pit-timer.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-50%) translateX(100%); }
            to { transform: translateY(-50%) translateX(0); }
        }

        .pit-timer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .pit-timer-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--danger-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pit-timer-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.3rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .pit-timer-close:hover {
            background: var(--accent-bg);
            color: var(--text-primary);
        }

        .pit-timer-display {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .pit-timer-time {
            font-size: 3rem;
            font-weight: bold;
            color: var(--warning-color);
            font-family: 'Courier New', monospace;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .pit-timer-stage {
            background: var(--accent-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--info-color);
        }

        .pit-timer-stage.active {
            background: linear-gradient(135deg, var(--danger-color), var(--warning-color));
            color: white;
            font-weight: bold;
            border-left-color: white;
            animation: pulse 2s infinite;
        }

        .pit-timer-stage-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
        }

        .pit-timer-stage-desc {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .pit-timer-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .pit-timer-btn {
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pit-timer-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .pit-timer-btn.start {
            background: var(--success-color);
            color: white;
        }

        .pit-timer-btn.stop {
            background: var(--danger-color);
            color: white;
        }

        .pit-timer-btn.reset {
            background: var(--text-muted);
            color: white;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Auto-refresh indicator */
        .refresh-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--success-color);
            font-size: 0.8rem;
        }

        .refresh-indicator.refreshing {
            color: var(--warning-color);
        }

        .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-radio"></i>
                <div>
                    <h1>ER:LC CAD/MDT</h1>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Emergency Response Dispatch System</div>
                </div>
            </div>
            
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-number" id="activeUnits">0</span>
                    <span class="stat-label">Active Units</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="activeCalls">0</span>
                    <span class="stat-label">Active Calls</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="onlineDispatchers">1</span>
                    <span class="stat-label">Dispatchers</span>
                </div>
                <div class="clock" id="clock">--:--:--</div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel -->
        <div class="left-panel">
            <!-- Action Bar -->
            <div class="action-bar">
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openNewCallModal()">
                        <i class="fas fa-plus"></i> New Call
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-police" onclick="toggleLEOMenu(event)">
                            <i class="fas fa-shield-alt"></i> Add LEO <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="btn-submenu" id="leoSubmenu">
                            <div class="btn-submenu-item" onclick="openNewUnitModal('RCPD')">
                                <i class="fas fa-shield-alt"></i> RCPD
                            </div>
                            <div class="btn-submenu-item" onclick="openNewUnitModal('LCSO')">
                                <i class="fas fa-star"></i> LCSO
                            </div>
                            <div class="btn-submenu-item" onclick="openNewUnitModal('LST')">
                                <i class="fas fa-road"></i> LST
                            </div>
                            <div class="btn-submenu-item" onclick="openNewUnitModal('METRO')">
                                <i class="fas fa-city"></i> METRO
                            </div>
                            <div class="btn-submenu-item" onclick="openNewUnitModal('SWAT')">
                                <i class="fas fa-user-ninja"></i> SWAT
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-fire" onclick="openNewUnitModal('RCFD')">
                        <i class="fas fa-fire"></i> Add RCFD
                    </button>
                    <button class="btn btn-ems" onclick="openNewUnitModal('RCMS')">
                        <i class="fas fa-ambulance"></i> Add RCMS
                    </button>
                    <button class="btn btn-warning" onclick="toggleSignal100()">
                        <i class="fas fa-exclamation-triangle"></i> Signal 100
                    </button>
                    <button class="btn btn-danger" onclick="togglePitTimer()">
                        <i class="fas fa-stopwatch"></i> Pit Timer
                    </button>
                    <button class="btn btn-success" onclick="exportData()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>

            <!-- Units Table -->
            <div class="data-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-users"></i>
                        Active Units
                    </div>
                    <div class="refresh-indicator" id="unitsRefresh">
                        <i class="fas fa-sync-alt"></i>
                        <span>Auto-refresh: ON</span>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="unitsTable">
                        <thead>
                            <tr>
                                <th>Callsign</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Assignment</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="unitsTableBody">
                            <!-- Units will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Statistics Panel -->
            <div class="data-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-chart-bar"></i>
                        Department Statistics
                    </div>
                </div>
                <div style="padding: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                        <div style="text-align: center; padding: 1rem; background: var(--accent-bg); border-radius: 6px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--rcpd-color);" id="rcpdCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">RCPD</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--accent-bg); border-radius: 6px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--lcso-color);" id="lcsoCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">LCSO</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--accent-bg); border-radius: 6px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--rcfd-color);" id="rcfdCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">RCFD</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--accent-bg); border-radius: 6px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--rcms-color);" id="rcmsCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">RCMS</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--accent-bg); border-radius: 6px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--lst-color);" id="lstCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">LST</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--accent-bg); border-radius: 6px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--metro-color);" id="metroCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">METRO</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--accent-bg); border-radius: 6px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--swat-color); background: white; border-radius: 4px;" id="swatCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">SWAT</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <!-- Active Calls -->
            <div data-section class="active-calls">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-phone"></i>
                        Active Calls
                    </div>
                    <div class="refresh-indicator" id="callsRefresh">
                        <i class="fas fa-sync-alt"></i>
                        <span>Live</span>
                    </div>
                </div>
                <div class="table-container" style="max-height: 400px;">
                    <table class="data-table" id="callsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Priority</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Status</th>
                                <th>Units</th>
                            </tr>
                        </thead>
                        <tbody id="callsTableBody">
                            <!-- Calls will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Dispatch Log -->
            <div class="data-section dispatch-log">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-history"></i>
                        Dispatch Log
                    </div>
                    <button class="quick-btn" onclick="clearLog()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
                <div class="log-container" id="dispatchLog">
                    <!-- Log entries will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- New Call Modal -->
    <div class="modal" id="newCallModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Call</h2>
                <button class="close-btn" onclick="closeModal('newCallModal')">&times;</button>
            </div>
            <form id="newCallForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="callPriority" required>
                            <option value="">Select Priority</option>
                            <option value="High">High Priority</option>
                            <option value="Medium">Medium Priority</option>
                            <option value="Low">Low Priority</option>
                            <option value="Routine">Routine</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Call Type</label>
                        <select class="form-select" id="callType" required>
                            <option value="">Select Type</option>
                            <optgroup label="Police">
                                <option value="Traffic Stop">Traffic Stop</option>
                                <option value="Domestic Violence">Domestic Violence</option>
                                <option value="Burglary">Burglary</option>
                                <option value="Assault">Assault</option>
                                <option value="Robbery">Robbery</option>
                                <option value="Suspicious Activity">Suspicious Activity</option>
                                <option value="Welfare Check">Welfare Check</option>
                                <option value="Pursuit">Vehicle Pursuit</option>
                                <option value="Shots Fired">Shots Fired</option>
                                <option value="Armed Subject">Armed Subject</option>
                            </optgroup>
                            <optgroup label="Fire">
                                <option value="Structure Fire">Structure Fire</option>
                                <option value="Vehicle Fire">Vehicle Fire</option>
                                <option value="Brush Fire">Brush Fire</option>
                                <option value="Alarm">Fire Alarm</option>
                                <option value="Hazmat">Hazmat Incident</option>
                                <option value="Rescue">Technical Rescue</option>
                            </optgroup>
                            <optgroup label="EMS">
                                <option value="Medical Emergency">Medical Emergency</option>
                                <option value="Cardiac Arrest">Cardiac Arrest</option>
                                <option value="Motor Vehicle Accident">Motor Vehicle Accident</option>
                                <option value="Overdose">Drug Overdose</option>
                                <option value="Psychiatric">Psychiatric Emergency</option>
                                <option value="Trauma">Trauma</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-input" id="callLocation" placeholder="Enter location or address" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="callDescription" placeholder="Detailed description of the incident" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Caller Name</label>
                        <input type="text" class="form-input" id="callerName" placeholder="Caller's name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Callback Number</label>
                        <input type="tel" class="form-input" id="callbackNumber" placeholder="Phone number">
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn" style="background: var(--text-muted);" onclick="closeModal('newCallModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Call</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Unit Modal -->
    <div class="modal" id="newUnitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="unitModalTitle">Add New Unit</h2>
                <button class="close-btn" onclick="closeModal('newUnitModal')">&times;</button>
            </div>
            <form id="newUnitForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Callsign</label>
                        <input type="text" class="form-input" id="unitCallsign" placeholder="Unit callsign" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="unitDepartment" required>
                            <option value="">Select Department</option>
                            <option value="RCPD">RCPD (River City Police)</option>
                            <option value="LCSO">LCSO (Liberty County Sheriff)</option>
                            <option value="RCFD">RCFD (River City Fire)</option>
                            <option value="RCMS">RCMS (River City Medical)</option>
                            <option value="LST">LST (Liberty State Troopers)</option>
                            <option value="METRO">METRO (Metropolitan Police)</option>
                            <option value="SWAT">SWAT (Special Weapons & Tactics)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="unitStatus" required>
                            <option value="Available">Available</option>
                            <option value="Busy">Busy</option>
                            <option value="Enroute">Enroute</option>
                            <option value="On Scene">On Scene</option>
                            <option value="Offline">Offline</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Current Location</label>
                        <input type="text" class="form-input" id="unitLocation" placeholder="Current location">
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn" style="background: var(--text-muted);" onclick="closeModal('newUnitModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Unit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Unit Modal -->
    <div class="modal" id="editUnitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Unit</h2>
                <button class="close-btn" onclick="closeModal('editUnitModal')">&times;</button>
            </div>
            <form id="editUnitForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Callsign</label>
                        <input type="text" class="form-input" id="editUnitCallsign" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="editUnitDepartment" required>
                            <option value="RCPD">RCPD (Rockport City Police)</option>
                            <option value="LCSO">LCSO (Liberty County Sheriff)</option>
                            <option value="RCFD">RCFD (Rockport City Fire)</option>
                            <option value="RCMS">RCMS (Rockport City Medical)</option>
                            <option value="LST">LST (Liberty State Troopers)</option>
                            <option value="METRO">METRO (Metropolitan Police)</option>
                            <option value="SWAT">SWAT (Special Weapons & Tactics)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="editUnitStatus" required>
                            <option value="Available">Available</option>
                            <option value="Busy">Busy</option>
                            <option value="Enroute">Enroute</option>
                            <option value="On Scene">On Scene</option>
                            <option value="Offline">Offline</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Current Location</label>
                        <input type="text" class="form-input" id="editUnitLocation">
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn" style="background: var(--text-muted);" onclick="closeModal('editUnitModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
                <input type="hidden" id="editUnitId">
            </form>
        </div>
    </div>

    <!-- Edit Call Modal -->
    <div class="modal" id="editCallModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Call</h2>
                <button class="close-btn" onclick="closeModal('editCallModal')">&times;</button>
            </div>
            <form id="editCallForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="editCallPriority" required>
                            <option value="High">High Priority</option>
                            <option value="Medium">Medium Priority</option>
                            <option value="Low">Low Priority</option>
                            <option value="Routine">Routine</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="editCallStatus" required>
                            <option value="Active">Active</option>
                            <option value="Pending">Pending</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Call Type</label>
                    <select class="form-select" id="editCallType" required>
                        <option value="">Select Type</option>
                        <optgroup label="Police">
                            <option value="Traffic Stop">Traffic Stop</option>
                            <option value="Domestic Violence">Domestic Violence</option>
                            <option value="Burglary">Burglary</option>
                            <option value="Assault">Assault</option>
                            <option value="Robbery">Robbery</option>
                            <option value="Suspicious Activity">Suspicious Activity</option>
                            <option value="Welfare Check">Welfare Check</option>
                            <option value="Pursuit">Vehicle Pursuit</option>
                            <option value="Shots Fired">Shots Fired</option>
                            <option value="Armed Subject">Armed Subject</option>
                        </optgroup>
                        <optgroup label="Fire">
                            <option value="Structure Fire">Structure Fire</option>
                            <option value="Vehicle Fire">Vehicle Fire</option>
                            <option value="Brush Fire">Brush Fire</option>
                            <option value="Alarm">Fire Alarm</option>
                            <option value="Hazmat">Hazmat Incident</option>
                            <option value="Rescue">Technical Rescue</option>
                        </optgroup>
                        <optgroup label="EMS">
                            <option value="Medical Emergency">Medical Emergency</option>
                            <option value="Cardiac Arrest">Cardiac Arrest</option>
                            <option value="Motor Vehicle Accident">Motor Vehicle Accident</option>
                            <option value="Overdose">Drug Overdose</option>
                            <option value="Psychiatric">Psychiatric Emergency</option>
                            <option value="Trauma">Trauma</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-input" id="editCallLocation" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="editCallDescription" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Caller Name</label>
                        <input type="text" class="form-input" id="editCallerName">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Callback Number</label>
                        <input type="tel" class="form-input" id="editCallbackNumber">
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn" style="background: var(--text-muted);" onclick="closeModal('editCallModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
                <input type="hidden" id="editCallId">
            </form>
        </div>
    </div>

    <!-- Assign to Call Modal -->
    <div class="modal" id="assignToCallModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Assign Unit to Call</h2>
                <button class="close-btn" onclick="closeModal('assignToCallModal')">&times;</button>
            </div>
            <div id="assignToCallContent">
                <div class="form-group">
                    <label class="form-label">Select Call:</label>
                    <select class="form-select" id="assignCallSelect" required>
                        <option value="">Choose a call...</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn" style="background: var(--text-muted);" onclick="closeModal('assignToCallModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmAssignment()">Assign Unit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal" id="viewDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="detailsModalTitle">Details</h2>
                <button class="close-btn" onclick="closeModal('viewDetailsModal')">&times;</button>
            </div>
            <div id="detailsContent">
                <!-- Details content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Create Union Modal -->
    <div class="modal" id="createUnionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Unit Union</h2>
                <button class="close-btn" onclick="closeModal('createUnionModal')">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">Union Name</label>
                    <input type="text" class="form-input" id="unionName" placeholder="Enter union name (e.g., Alpha Team)">
                </div>
                <div class="form-group">
                    <label class="form-label">Select Units to Include:</label>
                    <div id="unionUnitsList" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 1rem;">
                        <!-- Available units will be listed here -->
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn" style="background: var(--text-muted);" onclick="closeModal('createUnionModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmUnionCreation()">Create Union</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="editSelectedItem()">
            <i class="fas fa-edit"></i> Edit
        </div>
        <div class="context-menu-item" onclick="assignToCall()">
            <i class="fas fa-phone"></i> Assign to Call
        </div>
        <div class="context-menu-item has-submenu" id="statusMenuItem">
            <i class="fas fa-exchange-alt"></i> Change Status
            <div class="submenu" id="statusSubmenu">
                <div class="submenu-item" onclick="changeUnitStatus('Available')">
                    <i class="fas fa-check-circle" style="color: var(--success-color);"></i> Available
                </div>
                <div class="submenu-item" onclick="changeUnitStatus('Busy')">
                    <i class="fas fa-times-circle" style="color: var(--danger-color);"></i> Busy
                </div>
                <div class="submenu-item" onclick="changeUnitStatus('Enroute')">
                    <i class="fas fa-arrow-right" style="color: var(--warning-color);"></i> Enroute
                </div>
                <div class="submenu-item" onclick="changeUnitStatus('On Scene')">
                    <i class="fas fa-map-marker-alt" style="color: var(--info-color);"></i> On Scene
                </div>
                <div class="submenu-item" onclick="changeUnitStatus('Offline')">
                    <i class="fas fa-power-off" style="color: var(--text-muted);"></i> Offline
                </div>
            </div>
        </div>
        <div class="context-menu-item has-submenu" id="callStatusMenuItem" style="display: none;">
            <i class="fas fa-flag"></i> Change Call Status
            <div class="submenu" id="callStatusSubmenu">
                <div class="submenu-item" onclick="changeCallStatus('Active')">
                    <i class="fas fa-play" style="color: var(--success-color);"></i> Active
                </div>
                <div class="submenu-item" onclick="changeCallStatus('Pending')">
                    <i class="fas fa-clock" style="color: var(--warning-color);"></i> Pending
                </div>
                <div class="submenu-item" onclick="changeCallStatus('Closed')">
                    <i class="fas fa-check" style="color: var(--text-muted);"></i> Closed
                </div>
            </div>
        </div>
        <div class="context-menu-item" onclick="createUnion()">
            <i class="fas fa-link"></i> Create Union
        </div>
        <div class="context-menu-item" onclick="viewDetails()">
            <i class="fas fa-info-circle"></i> View Details
        </div>
        <div class="context-menu-item danger" onclick="removeItem()">
            <i class="fas fa-trash"></i> Remove
        </div>
    </div>

    <!-- Signal 100 Banner -->
    <div id="signal100Banner" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(45deg, #ff0000, #cc0000);
        color: white;
        text-align: center;
        padding: 1rem;
        font-size: 1.2rem;
        font-weight: bold;
        z-index: 9999;
        box-shadow: 0 4px 20px rgba(255,0,0,0.5);
        animation: pulse 2s infinite;
    ">
        🚨 SIGNAL 100 - EMERGENCY RADIO SILENCE - ALL NON-ESSENTIAL UNITS STAND BY 🚨
    </div>

    <!-- Pit Timer -->
    <div class="pit-timer" id="pitTimer">
        <div class="pit-timer-header">
            <div class="pit-timer-title">
                <i class="fas fa-car-crash"></i>
                PURSUIT TIMER
            </div>
            <button class="pit-timer-close" onclick="closePitTimer()">&times;</button>
        </div>
        
        <div class="pit-timer-display">
            <div class="pit-timer-time" id="pitTimerDisplay">00:00</div>
        </div>

        <div class="pit-timer-stages" id="pitTimerStages">
            <div class="pit-timer-stage" data-time="0">
                <div class="pit-timer-stage-title">🚨 PURSUIT BEGINS</div>
                <div class="pit-timer-stage-desc">Units in pursuit - All available units stand by</div>
            </div>
            
            <div class="pit-timer-stage" data-time="30">
                <div class="pit-timer-stage-title">📢 SIGNAL 100</div>
                <div class="pit-timer-stage-desc">Emergency radio silence - Critical traffic only</div>
            </div>
            
            <div class="pit-timer-stage" data-time="60">
                <div class="pit-timer-stage-title">⚡ NON-LETHALS AUTHORIZED</div>
                <div class="pit-timer-stage-desc">Taser and other non-lethal measures approved</div>
            </div>
            
            <div class="pit-timer-stage" data-time="120">
                <div class="pit-timer-stage-title">🚁 AIR SUPPORT AUTHORIZED</div>
                <div class="pit-timer-stage-desc">Helicopter units cleared for pursuit assistance</div>
            </div>
            
            <div class="pit-timer-stage" data-time="180">
                <div class="pit-timer-stage-title">🚧 PITS & SPIKES AUTHORIZED</div>
                <div class="pit-timer-stage-desc">PIT maneuvers and spike strips approved</div>
            </div>
        </div>

        <div class="pit-timer-controls">
            <button class="pit-timer-btn start" id="pitStartBtn" onclick="startPitTimer()">
                <i class="fas fa-play"></i> Start
            </button>
            <button class="pit-timer-btn stop" id="pitStopBtn" onclick="stopPitTimer()" style="display: none;">
                <i class="fas fa-pause"></i> Stop
            </button>
            <button class="pit-timer-btn reset" onclick="resetPitTimer()">
                <i class="fas fa-redo"></i> Reset
            </button>
        </div>
    </div>

    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
    </style>

    <script>
        // Global variables
        let calls = JSON.parse(localStorage.getItem('erlc_calls') || '[]');
        let units = JSON.parse(localStorage.getItem('erlc_units') || '[]');
        let unions = JSON.parse(localStorage.getItem('erlc_unions') || '[]');
        let callCounter = parseInt(localStorage.getItem('erlc_callCounter') || '1');
        let dispatchLog = JSON.parse(localStorage.getItem('erlc_dispatchLog') || '[]');
        let selectedRow = null;
        let selectedType = null;
        let selectedId = null;
        let signal100Active = false;
        let pitTimerActive = false;
        let pitTimerInterval = null;
        let pitTimerStartTime = null;
        let pitTimerElapsed = 0;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            startClock();
            setInterval(updateStats, 1000);
            setInterval(autoSave, 30000); // Auto-save every 30 seconds
        });

        function initializeApp() {
            renderUnitsTable();
            renderCallsTable();
            renderDispatchLog();
            updateStats();
            setupEventListeners();
            logDispatch('System', 'CAD/MDT System initialized');
        }

        function setupEventListeners() {
            // Form submissions
            document.getElementById('newCallForm').addEventListener('submit', handleNewCall);
            document.getElementById('newUnitForm').addEventListener('submit', handleNewUnit);
            document.getElementById('editUnitForm').addEventListener('submit', handleEditUnit);
            document.getElementById('editCallForm').addEventListener('submit', handleEditCall);

            // Context menu
            document.addEventListener('contextmenu', handleContextMenu);
            document.addEventListener('click', hideContextMenu);

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        function startClock() {
            function updateClock() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('clock').textContent = timeString;
            }
            updateClock();
            setInterval(updateClock, 1000);
        }

        function updateStats() {
            document.getElementById('activeUnits').textContent = units.filter(u => u.status !== 'Offline').length;
            document.getElementById('activeCalls').textContent = calls.filter(c => c.status !== 'Closed').length;
            document.getElementById('rcpdCount').textContent = units.filter(u => u.department === 'RCPD').length;
            document.getElementById('lcsoCount').textContent = units.filter(u => u.department === 'LCSO').length;
            document.getElementById('rcfdCount').textContent = units.filter(u => u.department === 'RCFD').length;
            document.getElementById('rcmsCount').textContent = units.filter(u => u.department === 'RCMS').length;
            document.getElementById('lstCount').textContent = units.filter(u => u.department === 'LST').length;
            document.getElementById('metroCount').textContent = units.filter(u => u.department === 'METRO').length;
            document.getElementById('swatCount').textContent = units.filter(u => u.department === 'SWAT').length;
        }

        // Modal functions
        function openNewCallModal() {
            document.getElementById('newCallModal').style.display = 'block';
            document.getElementById('callPriority').focus();
        }

        function openNewUnitModal(department = '') {
            document.getElementById('newUnitModal').style.display = 'block';
            if (department) {
                document.getElementById('unitDepartment').value = department;
                document.getElementById('unitModalTitle').textContent = `Add New ${department} Unit`;
            }
            document.getElementById('unitCallsign').focus();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Reset forms
            if (modalId === 'newCallModal') {
                document.getElementById('newCallForm').reset();
            }
            if (modalId === 'newUnitModal') {
                document.getElementById('newUnitForm').reset();
                document.getElementById('unitModalTitle').textContent = 'Add New Unit';
            }
        }

        // Call management
        function handleNewCall(e) {
            e.preventDefault();
            
            const call = {
                id: callCounter++,
                priority: document.getElementById('callPriority').value,
                type: document.getElementById('callType').value,
                location: document.getElementById('callLocation').value,
                description: document.getElementById('callDescription').value,
                callerName: document.getElementById('callerName').value,
                callbackNumber: document.getElementById('callbackNumber').value,
                status: 'Pending',
                assignedUnits: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            calls.push(call);
            saveData();
            renderCallsTable();
            closeModal('newCallModal');
            
            logDispatch('Call Created', `${call.type} at ${call.location} - ID: ${String(call.id).padStart(4, '0')}`);
            updateStats();
        }

        function handleNewUnit(e) {
            e.preventDefault();
            
            const callsign = document.getElementById('unitCallsign').value.toUpperCase();
            
            // Check for duplicate callsign
            if (units.find(u => u.callsign === callsign)) {
                alert('A unit with this callsign already exists!');
                return;
            }

            const unit = {
                id: Date.now(),
                callsign: callsign,
                department: document.getElementById('unitDepartment').value,
                status: document.getElementById('unitStatus').value,
                location: document.getElementById('unitLocation').value,
                assignment: null,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            units.push(unit);
            saveData();
            renderUnitsTable();
            closeModal('newUnitModal');
            
            logDispatch('Unit Added', `${unit.callsign} (${unit.department})`);
            updateStats();
        }

        function handleEditUnit(e) {
            e.preventDefault();
            
            const unitId = parseInt(document.getElementById('editUnitId').value);
            const unit = units.find(u => u.id === unitId);
            if (!unit) return;
            
            const oldCallsign = unit.callsign;
            unit.callsign = document.getElementById('editUnitCallsign').value.toUpperCase();
            unit.department = document.getElementById('editUnitDepartment').value;
            unit.status = document.getElementById('editUnitStatus').value;
            unit.location = document.getElementById('editUnitLocation').value;
            unit.updatedAt = new Date().toISOString();
            
            saveData();
            renderUnitsTable();
            updateStats();
            closeModal('editUnitModal');
            
            logDispatch('Unit Updated', `${oldCallsign} updated to ${unit.callsign} (${unit.department})`);
        }

        function handleEditCall(e) {
            e.preventDefault();
            
            const callId = parseInt(document.getElementById('editCallId').value);
            const call = calls.find(c => c.id === callId);
            if (!call) return;
            
            call.priority = document.getElementById('editCallPriority').value;
            call.status = document.getElementById('editCallStatus').value;
            call.type = document.getElementById('editCallType').value;
            call.location = document.getElementById('editCallLocation').value;
            call.description = document.getElementById('editCallDescription').value;
            call.callerName = document.getElementById('editCallerName').value;
            call.callbackNumber = document.getElementById('editCallbackNumber').value;
            call.updatedAt = new Date().toISOString();
            
            saveData();
            renderCallsTable();
            updateStats();
            closeModal('editCallModal');
            
            logDispatch('Call Updated', `Call #${String(call.id).padStart(4, '0')} updated - ${call.type} at ${call.location}`);
        }

        // Render functions
        function renderUnitsTable() {
            const tbody = document.getElementById('unitsTableBody');
            tbody.innerHTML = '';

            units.forEach(unit => {
                const row = document.createElement('tr');
                row.dataset.unitId = unit.id;
                row.dataset.type = 'unit';
                
                const statusClass = `status-${unit.status.toLowerCase().replace(' ', '')}`;
                const deptClass = `dept-${unit.department.toLowerCase()}`;
                
                row.innerHTML = `
                    <td><strong class="${deptClass}">${unit.callsign}</strong></td>
                    <td><span class="${deptClass}">${unit.department}</span></td>
                    <td><span class="status-badge ${statusClass}">${unit.status}</span></td>
                    <td>${unit.assignment || 'Unassigned'}</td>
                    <td>${unit.location || 'Unknown'}</td>
                    <td>${unit.officers || 'Unassigned'}</td>
                    <td>
                        <div class="quick-actions">
                            <button class="quick-btn" onclick="editUnit(${unit.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="quick-btn" onclick="toggleUnitStatus(${unit.id})" title="Change Status">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <button class="quick-btn" onclick="removeUnit(${unit.id})" title="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function renderCallsTable() {
            const tbody = document.getElementById('callsTableBody');
            tbody.innerHTML = '';

            calls.forEach(call => {
                const row = document.createElement('tr');
                row.dataset.callId = call.id;
                row.dataset.type = 'call';
                
                const priorityClass = `priority-${call.priority.toLowerCase()}`;
                
                row.innerHTML = `
                    <td><strong>${String(call.id).padStart(4, '0')}</strong></td>
                    <td><span class="status-badge ${priorityClass}">${call.priority}</span></td>
                    <td>${call.type}</td>
                    <td>${call.location}</td>
                    <td>${call.status}</td>
                    <td>${call.assignedUnits.length > 0 ? call.assignedUnits.join(', ') : 'None'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function renderDispatchLog() {
            const logContainer = document.getElementById('dispatchLog');
            logContainer.innerHTML = '';

            // Show only last 50 entries
            const recentLogs = dispatchLog.slice(-50).reverse();
            
            recentLogs.forEach(entry => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry fade-in';
                
                const time = new Date(entry.timestamp).toLocaleTimeString('en-US', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                logEntry.innerHTML = `
                    <div class="log-time">${time}</div>
                    <div><strong>${entry.type}:</strong> ${entry.message}</div>
                `;
                
                logContainer.appendChild(logEntry);
            });

            // Auto-scroll to top (most recent)
            logContainer.scrollTop = 0;
        }

        // Utility functions
        function logDispatch(type, message) {
            const entry = {
                timestamp: new Date().toISOString(),
                type: type,
                message: message
            };
            
            dispatchLog.push(entry);
            
            // Keep only last 200 entries
            if (dispatchLog.length > 200) {
                dispatchLog = dispatchLog.slice(-200);
            }
            
            saveData();
            renderDispatchLog();
        }

        function saveData() {
            localStorage.setItem('erlc_calls', JSON.stringify(calls));
            localStorage.setItem('erlc_units', JSON.stringify(units));
            localStorage.setItem('erlc_callCounter', callCounter.toString());
            localStorage.setItem('erlc_dispatchLog', JSON.stringify(dispatchLog));
        }

        function autoSave() {
            saveData();
            // Show brief save indicator
            const indicator = document.getElementById('unitsRefresh');
            indicator.innerHTML = '<div class="spinner"></div><span>Saving...</span>';
            indicator.className = 'refresh-indicator refreshing';
            
            setTimeout(() => {
                indicator.innerHTML = '<i class="fas fa-sync-alt"></i><span>Auto-refresh: ON</span>';
                indicator.className = 'refresh-indicator';
            }, 1000);
        }

        // Unit management
        function toggleUnitStatus(unitId) {
            const unit = units.find(u => u.id === unitId);
            if (!unit) return;

            const statuses = ['Available', 'Busy', 'Enroute', 'On Scene', 'Offline'];
            const currentIndex = statuses.indexOf(unit.status);
            const nextIndex = (currentIndex + 1) % statuses.length;
            
            const oldStatus = unit.status;
            unit.status = statuses[nextIndex];
            unit.updatedAt = new Date().toISOString();
            
            saveData();
            renderUnitsTable();
            updateStats();
            
            logDispatch('Status Change', `${unit.callsign}: ${oldStatus} → ${unit.status}`);
        }

        function removeUnit(unitId) {
            const unit = units.find(u => u.id === unitId);
            if (!unit) return;

            if (confirm(`Remove unit ${unit.callsign}?`)) {
                units = units.filter(u => u.id !== unitId);
                saveData();
                renderUnitsTable();
                updateStats();
                
                logDispatch('Unit Removed', `${unit.callsign} (${unit.department})`);
            }
        }

        // Signal 100 functionality
        function toggleSignal100() {
            signal100Active = !signal100Active;
            const banner = document.getElementById('signal100Banner');
            
            if (signal100Active) {
                banner.style.display = 'block';
                logDispatch('SIGNAL 100', 'Emergency radio silence activated - All non-essential units stand by');
            } else {
                banner.style.display = 'none';
                logDispatch('SIGNAL 100', 'Emergency radio silence lifted - Normal operations resumed');
            }
        }

        // Context menu functionality
        function handleContextMenu(e) {
            const row = e.target.closest('tr[data-unit-id], tr[data-call-id]');
            if (!row) return;

            e.preventDefault();
            
            selectedRow = row;
            selectedType = row.dataset.type;
            selectedId = row.dataset.unitId ? parseInt(row.dataset.unitId) : parseInt(row.dataset.callId);
            
            const contextMenu = document.getElementById('contextMenu');
            const statusMenuItem = document.getElementById('statusMenuItem');
            const callStatusMenuItem = document.getElementById('callStatusMenuItem');
            
            // Show/hide menu items based on selection type
            if (selectedType === 'unit') {
                statusMenuItem.style.display = 'block';
                callStatusMenuItem.style.display = 'none';
            } else if (selectedType === 'call') {
                statusMenuItem.style.display = 'none';
                callStatusMenuItem.style.display = 'block';
            }
            
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            
            // Highlight selected row
            document.querySelectorAll('tr.selected').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            document.querySelectorAll('tr.selected').forEach(r => r.classList.remove('selected'));
        }

        // Keyboard shortcuts
        function handleKeyboardShortcuts(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'n':
                        e.preventDefault();
                        openNewCallModal();
                        break;
                    case 'u':
                        e.preventDefault();
                        openNewUnitModal();
                        break;
                    case 's':
                        e.preventDefault();
                        saveData();
                        break;
                }
            }
            
            if (e.key === 'Escape') {
                // Close any open modals
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
                hideContextMenu();
            }
        }

        // Export functionality
        function exportData() {
            const data = {
                calls: calls,
                units: units,
                dispatchLog: dispatchLog,
                exportDate: new Date().toISOString(),
                system: 'ER:LC CAD/MDT'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            a.href = url;
            a.download = `ERLC-CAD-Export-${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logDispatch('Data Export', 'System data exported successfully');
        }

        function clearLog() {
            if (confirm('Clear dispatch log? This action cannot be undone.')) {
                dispatchLog = [];
                saveData();
                renderDispatchLog();
                logDispatch('System', 'Dispatch log cleared');
            }
        }

        // Context menu actions (placeholder implementations)
        function editSelectedItem() {
            if (!selectedRow) return;
            
            if (selectedType === 'unit') {
                const unitId = parseInt(selectedRow.dataset.unitId);
                editUnit(unitId);
            } else if (selectedType === 'call') {
                const callId = parseInt(selectedRow.dataset.callId);
                editCall(callId);
            }
            hideContextMenu();
        }

        function assignToCall() {
            if (!selectedRow || selectedType !== 'unit') return;
            
            const unitId = parseInt(selectedRow.dataset.unitId);
            const unit = units.find(u => u.id === unitId);
            if (!unit) return;
            
            selectedId = unitId;
            
            // Populate call selection dropdown
            const select = document.getElementById('assignCallSelect');
            select.innerHTML = '<option value="">Choose a call...</option>';
            
            calls.filter(c => c.status === 'Active').forEach(call => {
                const option = document.createElement('option');
                option.value = call.id;
                option.textContent = `#${String(call.id).padStart(4, '0')} - ${call.type} at ${call.location}`;
                select.appendChild(option);
            });
            
            document.getElementById('assignToCallModal').style.display = 'block';
            hideContextMenu();
        }

        function changeUnitStatus(newStatus) {
            if (!selectedRow || selectedType !== 'unit') return;
            
            const unitId = parseInt(selectedRow.dataset.unitId);
            const unit = units.find(u => u.id === unitId);
            if (!unit) return;
            
            const oldStatus = unit.status;
            unit.status = newStatus;
            
            saveData();
            renderUnitsTable();
            updateStats();
            
            logDispatch('Unit Status', `${unit.callsign} status changed from ${oldStatus} to ${newStatus}`);
            hideContextMenu();
        }

        function changeCallStatus(newStatus) {
            if (!selectedRow || selectedType !== 'call') return;
            
            const callId = parseInt(selectedRow.dataset.callId);
            const call = calls.find(c => c.id === callId);
            if (!call) return;
            
            const oldStatus = call.status;
            call.status = newStatus;
            
            saveData();
            renderCallsTable();
            updateStats();
            
            logDispatch('Call Status', `Call #${String(call.id).padStart(4, '0')} status changed from ${oldStatus} to ${newStatus}`);
            hideContextMenu();
        }

        function createUnion() {
            if (!selectedRow || selectedType !== 'unit') return;
            
            selectedId = parseInt(selectedRow.dataset.unitId);
            
            // Populate units list for union creation
            const unitsList = document.getElementById('unionUnitsList');
            unitsList.innerHTML = '';
            
            units.forEach(unit => {
                const unitDiv = document.createElement('div');
                unitDiv.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--accent-bg); border-radius: 4px;';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = unit.id;
                checkbox.id = `unit_${unit.id}`;
                if (unit.id === selectedId) checkbox.checked = true;
                
                const label = document.createElement('label');
                label.htmlFor = `unit_${unit.id}`;
                label.textContent = `${unit.callsign} (${unit.department})`;
                label.style.cursor = 'pointer';
                
                unitDiv.appendChild(checkbox);
                unitDiv.appendChild(label);
                unitsList.appendChild(unitDiv);
            });
            
            document.getElementById('createUnionModal').style.display = 'block';
            hideContextMenu();
        }

        function viewDetails() {
            if (!selectedRow) return;
            
            let detailsHtml = '';
            let title = '';
            
            if (selectedType === 'unit') {
                const unitId = parseInt(selectedRow.dataset.unitId);
                const unit = units.find(u => u.id === unitId);
                if (!unit) return;
                
                title = `Unit Details - ${unit.callsign}`;
                detailsHtml = `
                    <div style="display: grid; gap: 1rem;">
                        <div><strong>Callsign:</strong> ${unit.callsign}</div>
                        <div><strong>Department:</strong> ${unit.department}</div>
                        <div><strong>Status:</strong> <span class="status-badge status-${unit.status.toLowerCase().replace(' ', '')}">${unit.status}</span></div>
                        <div><strong>Assignment:</strong> ${unit.assignment || 'Unassigned'}</div>
                        <div><strong>Location:</strong> ${unit.location || 'Unknown'}</div>
                        <div><strong>Added:</strong> ${new Date(unit.created).toLocaleString()}</div>
                    </div>
                `;
            } else if (selectedType === 'call') {
                const callId = parseInt(selectedRow.dataset.callId);
                const call = calls.find(c => c.id === callId);
                if (!call) return;
                
                title = `Call Details - #${String(call.id).padStart(4, '0')}`;
                detailsHtml = `
                    <div style="display: grid; gap: 1rem;">
                        <div><strong>Call ID:</strong> #${String(call.id).padStart(4, '0')}</div>
                        <div><strong>Priority:</strong> <span class="status-badge priority-${call.priority.toLowerCase()}">${call.priority}</span></div>
                        <div><strong>Type:</strong> ${call.type}</div>
                        <div><strong>Location:</strong> ${call.location}</div>
                        <div><strong>Status:</strong> ${call.status}</div>
                        <div><strong>Description:</strong> ${call.description}</div>
                        <div><strong>Caller:</strong> ${call.callerName || 'Unknown'}</div>
                        <div><strong>Callback:</strong> ${call.callbackNumber || 'None'}</div>
                        <div><strong>Assigned Units:</strong> ${call.assignedUnits.length > 0 ? call.assignedUnits.join(', ') : 'None'}</div>
                        <div><strong>Created:</strong> ${new Date(call.created).toLocaleString()}</div>
                    </div>
                `;
            }
            
            document.getElementById('detailsModalTitle').textContent = title;
            document.getElementById('detailsContent').innerHTML = detailsHtml;
            document.getElementById('viewDetailsModal').style.display = 'block';
            hideContextMenu();
        }

        function removeItem() {
            if (!selectedRow) return;
            
            if (selectedType === 'unit') {
                const unitId = parseInt(selectedRow.dataset.unitId);
                removeUnit(unitId);
            } else if (selectedType === 'call') {
                const callId = parseInt(selectedRow.dataset.callId);
                removeCall(callId);
            }
            hideContextMenu();
        }

        // Modal helper functions
        function confirmAssignment() {
            const callId = parseInt(document.getElementById('assignCallSelect').value);
            if (!callId || !selectedId) return;
            
            const unit = units.find(u => u.id === selectedId);
            const call = calls.find(c => c.id === callId);
            if (!unit || !call) return;
            
            // Add unit to call
            if (!call.assignedUnits.includes(unit.callsign)) {
                call.assignedUnits.push(unit.callsign);
                unit.assignment = `Call #${String(call.id).padStart(4, '0')}`;
                unit.status = 'Enroute';
                
                saveData();
                renderUnitsTable();
                renderCallsTable();
                updateStats();
                
                logDispatch('Unit Assignment', `${unit.callsign} assigned to call #${String(call.id).padStart(4, '0')} - ${call.type}`);
            }
            
            closeModal('assignToCallModal');
        }

        function confirmUnionCreation() {
            const unionName = document.getElementById('unionName').value.trim();
            if (!unionName) return;
            
            const selectedUnits = [];
            document.querySelectorAll('#unionUnitsList input[type="checkbox"]:checked').forEach(checkbox => {
                const unitId = parseInt(checkbox.value);
                const unit = units.find(u => u.id === unitId);
                if (unit) selectedUnits.push(unit);
            });
            
            if (selectedUnits.length < 2) {
                alert('Please select at least 2 units for the union.');
                return;
            }
            
            const union = {
                id: Date.now(),
                name: unionName,
                units: selectedUnits.map(u => u.callsign),
                created: new Date().toISOString()
            };
            
            unions.push(union);
            
            // Update unit assignments
            selectedUnits.forEach(unit => {
                unit.assignment = `Union: ${unionName}`;
            });
            
            saveData();
            renderUnitsTable();
            updateStats();
            
            logDispatch('Union Created', `${unionName} created with units: ${union.units.join(', ')}`);
            closeModal('createUnionModal');
        }

        function removeCall(callId) {
            const call = calls.find(c => c.id === callId);
            if (!call) return;

            if (confirm(`Remove call ${String(call.id).padStart(4, '0')} (${call.type})?`)) {
                calls = calls.filter(c => c.id !== callId);
                saveData();
                renderCallsTable();
                updateStats();
                
                logDispatch('Call Removed', `${call.type} at ${call.location} - ID: ${String(call.id).padStart(4, '0')}`);
            }
        }

        function editUnit(unitId) {
            const unit = units.find(u => u.id === unitId);
            if (!unit) return;
            
            // Populate the edit form
            document.getElementById('editUnitId').value = unit.id;
            document.getElementById('editUnitCallsign').value = unit.callsign;
            document.getElementById('editUnitDepartment').value = unit.department;
            document.getElementById('editUnitStatus').value = unit.status;
            document.getElementById('editUnitLocation').value = unit.location || '';
            
            // Show the modal
            document.getElementById('editUnitModal').style.display = 'block';
        }

        function editCall(callId) {
            const call = calls.find(c => c.id === callId);
            if (!call) return;
            
            // Populate the edit form
            document.getElementById('editCallId').value = call.id;
            document.getElementById('editCallPriority').value = call.priority;
            document.getElementById('editCallStatus').value = call.status;
            document.getElementById('editCallType').value = call.type;
            document.getElementById('editCallLocation').value = call.location;
            document.getElementById('editCallDescription').value = call.description;
            document.getElementById('editCallerName').value = call.callerName || '';
            document.getElementById('editCallbackNumber').value = call.callbackNumber || '';
            
            // Show the modal
            document.getElementById('editCallModal').style.display = 'block';
        }

        // Click outside modal to close
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Pit Timer Functions
        function togglePitTimer() {
            const pitTimer = document.getElementById('pitTimer');
            if (pitTimer.classList.contains('active')) {
                closePitTimer();
            } else {
                openPitTimer();
            }
        }

        function openPitTimer() {
            const pitTimer = document.getElementById('pitTimer');
            pitTimer.classList.add('active');
            logDispatch('Pit Timer', 'Pursuit timer opened');
        }

        function closePitTimer() {
            const pitTimer = document.getElementById('pitTimer');
            pitTimer.classList.remove('active');
            if (pitTimerActive) {
                stopPitTimer();
            }
            logDispatch('Pit Timer', 'Pursuit timer closed');
        }

        function startPitTimer() {
            if (pitTimerActive) return;
            
            pitTimerActive = true;
            pitTimerStartTime = Date.now() - (pitTimerElapsed * 1000);
            
            document.getElementById('pitStartBtn').style.display = 'none';
            document.getElementById('pitStopBtn').style.display = 'flex';
            
            pitTimerInterval = setInterval(updatePitTimer, 100);
            
            logDispatch('Pit Timer', 'Pursuit timer started');
            
            // Auto-activate Signal 100 if not already active
            if (!signal100Active) {
                setTimeout(() => {
                    if (pitTimerActive) {
                        toggleSignal100();
                        logDispatch('Pit Timer', 'Signal 100 auto-activated at 30 seconds');
                    }
                }, 30000);
            }
        }

        function stopPitTimer() {
            if (!pitTimerActive) return;
            
            pitTimerActive = false;
            clearInterval(pitTimerInterval);
            
            document.getElementById('pitStartBtn').style.display = 'flex';
            document.getElementById('pitStopBtn').style.display = 'none';
            
            logDispatch('Pit Timer', `Pursuit timer stopped at ${formatTime(pitTimerElapsed)}`);
        }

        function resetPitTimer() {
            stopPitTimer();
            pitTimerElapsed = 0;
            updatePitTimerDisplay();
            updatePitTimerStages();
            logDispatch('Pit Timer', 'Pursuit timer reset');
        }

        function updatePitTimer() {
            if (!pitTimerActive) return;
            
            const now = Date.now();
            pitTimerElapsed = Math.floor((now - pitTimerStartTime) / 1000);
            
            updatePitTimerDisplay();
            updatePitTimerStages();
        }

        function updatePitTimerDisplay() {
            const display = document.getElementById('pitTimerDisplay');
            display.textContent = formatTime(pitTimerElapsed);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updatePitTimerStages() {
            const stages = document.querySelectorAll('.pit-timer-stage');
            const timeThresholds = [0, 30, 60, 120, 180];
            
            stages.forEach((stage, index) => {
                const threshold = timeThresholds[index];
                const nextThreshold = timeThresholds[index + 1];
                
                if (pitTimerElapsed >= threshold && (nextThreshold === undefined || pitTimerElapsed < nextThreshold)) {
                    stage.classList.add('active');
                    
                    // Log stage changes
                    if (pitTimerElapsed === threshold && pitTimerActive) {
                        const stageTitle = stage.querySelector('.pit-timer-stage-title').textContent;
                        logDispatch('Pit Timer', `Stage reached: ${stageTitle}`);
                    }
                } else {
                    stage.classList.remove('active');
                }
            });
        }

        // Initialize pit timer display
        document.addEventListener('DOMContentLoaded', function() {
            updatePitTimerDisplay();
            updatePitTimerStages();
        });

        // LEO Menu Functions
        function toggleLEOMenu(event) {
            event.stopPropagation();
            const submenu = document.getElementById('leoSubmenu');
            submenu.classList.toggle('active');
            
            // Close menu when clicking outside
            if (submenu.classList.contains('active')) {
                document.addEventListener('click', closeLEOMenu);
            }
        }

        function closeLEOMenu() {
            const submenu = document.getElementById('leoSubmenu');
            submenu.classList.remove('active');
            document.removeEventListener('click', closeLEOMenu);
        }

        // Close LEO menu when clicking anywhere else
        document.addEventListener('click', function(event) {
            const btnGroup = event.target.closest('.btn-group');
            if (!btnGroup) {
                closeLEOMenu();
            }
        });
    </script>
</body>
</html>
